name: MIRRALISM Quality Gates

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # Enhanced Quality Gates with MIRRALISM Standards
  enhanced-quality-gates:
    name: ğŸ¯ Enhanced MIRRALISM Quality Gates
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better analysis

      - name: ğŸ Setup Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: ğŸ“¦ Install Quality Tools
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit black isort mypy bandit safety
          pip install radon xenon complexity-metrics
          pip install -r requirements.txt

      - name: ğŸ” Pre-commit Enhanced Check
        run: |
          pre-commit install
          pre-commit run --all-files --show-diff-on-failure

      - name: ğŸ“ Code Complexity Gate (MIRRALISM Standard)
        run: |
          echo "ğŸ¯ MIRRALISM Complexity Analysis"

          # Radon Complexity Check
          radon cc . --average --show-complexity > complexity-report.txt
          COMPLEXITY=$(radon cc . --average | tail -1 | awk '{print $NF}')

          echo "ğŸ“Š Average Complexity: $COMPLEXITY"
          echo "ğŸ¯ MIRRALISM Target: <2.0"

          # Fail if complexity exceeds MIRRALISM standards
          python -c "
          import sys
          complexity = float('$COMPLEXITY') if '$COMPLEXITY'.replace('.','').isdigit() else 0
          if complexity >= 2.0:
              print('âŒ COMPLEXITY GATE FAILED: Exceeds MIRRALISM standard')
              sys.exit(1)
          else:
              print('âœ… COMPLEXITY GATE PASSED: Meets MIRRALISM standard')
          "

      - name: ğŸ“ File Count Gate (500 File Limit)
        run: |
          echo "ğŸ“ MIRRALISM File Count Analysis"

          FILE_COUNT=$(find . -type f -name "*.py" -o -name "*.md" -o -name "*.json" -o -name "*.yml" | wc -l)
          echo "ğŸ“Š Current Files: $FILE_COUNT"
          echo "ğŸ¯ MIRRALISM Limit: 500"

          if [ $FILE_COUNT -ge 500 ]; then
            echo "âŒ FILE COUNT GATE FAILED: Exceeds 500 file limit"
            exit 1
          else
            echo "âœ… FILE COUNT GATE PASSED: Within MIRRALISM limit"
          fi

      - name: ğŸ”’ Security Quality Gate
        run: |
          echo "ğŸ”’ MIRRALISM Security Analysis"

          # Bandit Security Check
          bandit -r . -x tests/ -ll -f json -o bandit-results.json
          BANDIT_ISSUES=$(cat bandit-results.json | python -c "import sys,json; print(len(json.load(sys.stdin)['results']))")

          echo "ğŸ” Security Issues Found: $BANDIT_ISSUES"
          echo "ğŸ¯ MIRRALISM Standard: 0 high/medium issues"

          if [ $BANDIT_ISSUES -gt 0 ]; then
            echo "âŒ SECURITY GATE FAILED: Security issues detected"
            bandit -r . -x tests/ -ll
            exit 1
          else
            echo "âœ… SECURITY GATE PASSED: No security issues"
          fi

      - name: ğŸ§ª Test Coverage Gate (95% Standard)
        run: |
          echo "ğŸ§ª MIRRALISM Test Coverage Analysis"

          pip install pytest-cov
          coverage run -m pytest tests/ || true
          COVERAGE=$(coverage report | tail -1 | awk '{print $(NF-1)}' | sed 's/%//')

          echo "ğŸ“Š Test Coverage: ${COVERAGE}%"
          echo "ğŸ¯ MIRRALISM Standard: â‰¥95%"

          python -c "
          import sys
          coverage = float('$COVERAGE') if '$COVERAGE'.replace('.','').isdigit() else 0
          if coverage < 95.0:
              print('âŒ COVERAGE GATE FAILED: Below MIRRALISM standard')
              sys.exit(1)
          else:
              print('âœ… COVERAGE GATE PASSED: Meets MIRRALISM standard')
          "

      - name: ğŸ¯ MIRRALISM Philosophy Compliance
        run: |
          echo "ğŸ¯ MIRRALISM Philosophy Validation"

          # Check for V1 anti-patterns
          REDIRECT_FILES=$(find . -name "*REDIRECT*" | wc -l)
          if [ $REDIRECT_FILES -gt 0 ]; then
            echo "âŒ V1 ANTI-PATTERN DETECTED: REDIRECT files found"
            find . -name "*REDIRECT*"
            exit 1
          fi

          # Check for excessive complexity markers
          COMPLEX_FUNCTIONS=$(grep -r "TODO: Simplify" . | wc -l)
          if [ $COMPLEX_FUNCTIONS -gt 5 ]; then
            echo "âŒ COMPLEXITY DEBT: Too many 'TODO: Simplify' markers"
            exit 1
          fi

          echo "âœ… MIRRALISM PHILOSOPHY: Compliant"

      - name: ğŸ“Š Quality Gates Summary
        if: always()
        run: |
          echo "## ğŸ¯ MIRRALISM Quality Gates Report" > quality-report.md
          echo "**Date**: $(date)" >> quality-report.md
          echo "" >> quality-report.md
          echo "### Gate Results:" >> quality-report.md
          echo "- ğŸ“ **Code Complexity**: Check completed" >> quality-report.md
          echo "- ğŸ“ **File Count**: Check completed" >> quality-report.md
          echo "- ğŸ”’ **Security**: Check completed" >> quality-report.md
          echo "- ğŸ§ª **Test Coverage**: Check completed" >> quality-report.md
          echo "- ğŸ¯ **MIRRALISM Philosophy**: Check completed" >> quality-report.md
          echo "" >> quality-report.md
          echo "### Standards Applied:" >> quality-report.md
          echo "- Maximum Complexity: <2.0" >> quality-report.md
          echo "- File Limit: 500 files" >> quality-report.md
          echo "- Security: Zero tolerance" >> quality-report.md
          echo "- Coverage: â‰¥95%" >> quality-report.md
          echo "- V1 Anti-patterns: Forbidden" >> quality-report.md

      - name: ğŸ“‹ Upload Quality Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mirralism-quality-report
          path: |
            quality-report.md
            complexity-report.txt
            bandit-results.json
